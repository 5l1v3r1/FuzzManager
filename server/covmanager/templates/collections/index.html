{% extends 'layouts/layout_base.html' %}

{% load url from future %}
{% load extratags %}

{% block body_content %}

<div id="main" class="panel panel-default">
	<div class="panel-heading"><i class="glyphicon glyphicon-hdd"></i> Coverage Collections</div>
	<div class="panel-body">
            <input type="text" v-model="collection_search" />
	    <table class="table table-condensed table-hover table-bordered table-db">
		<thead>
		    <tr>
			<th style="width: 25px;">ID</th>
			<th style="width: 50px;">Created</th>
			<th style="width: 75px;">Repository</th>
			<th style="width: 100px;">Revision</th>
			<th style="width: 50px;">Branch</th>
			<th style="width: 100px;">Tools</th>
			<th style="width: 150px;">Description</th>
		    </tr>
                    <tr v-for="collection in collections">
                        <td>!{ collection.id }!</td>
                        <td>!{ collection.created | formatDate }!</td>
                        <td>!{ collection.repository }!</td>
                        <td>!{ collection.revision }!</td>
                        <td>!{ collection.branch }!</td>
                        <td>!{ collection.tools }!</td>
                        <td>!{ collection.description }!</td>
                    </tr>
		</thead>
		<tbody>
		</tbody>
	    </table>
	</div>

</div>

<script>
var apiURL = '{% url 'covmanager:collections_api' %}'

var app = new Vue({
  delimiters: ['!{', '}!'],

  el: '#main',

  data: {
    collection_search: '',
    collections: null
  },

  created: function () {
    this.fetchData()
  },

  watch: {
    collection_search: 'fetchData'
  },

  filters: {
    truncate: function (v) {
      var newline = v.indexOf('\n')
      return newline > 0 ? v.slice(0, newline) : v
    },
    formatDate: function (v) {
      return v.replace(/T|Z/g, ' ')
    }
  },

  methods: {
    fetchData: _.throttle(function () {
      var xhr = new XMLHttpRequest()
      var self = this
      var q = ""
      if (self.collection_search) {
        q = "?squery=" + self.collection_search
      }
      xhr.open('GET', apiURL + q)
      xhr.onload = function () {
        result = JSON.parse(xhr.responseText)
        self.collections = result["results"]
      }
      xhr.send()
    }, 500)
  }
})

</script>


{% endblock body_content %}
